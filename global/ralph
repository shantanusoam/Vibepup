#!/bin/bash
set -e

# ==============================================================================
# Ralph v3.0 - The "Split-Brain" Autonomous Agent Harness
# ==============================================================================
# Features:
# - Split PRD: prd.md (Human/Watch) vs prd.state.json (Agent/State)
# - Phase Detection: PLAN (Architecture) vs BUILD (Coding)
# - Smart Context: Rotates logs to prevent pollution
# - Model Routing: Custom priority chains for different phases
# ==============================================================================

# --- Configuration ---
ITERATIONS=5
WATCH_MODE="false"

# Model Priority: Build Phase (Implementation)
# High-speed/specialized coding models first, then heavy thinkers, then generic fallbacks
# Tier 1: Github Copilot (Standard)
# Tier 2: Github Copilot (Enterprise)
# Tier 3: OpenAI (Direct)
# Tier 4: Google (Direct)
# Tier 5: Zen (Opencode Fallback)
BUILD_MODELS_PREF=(
    "github-copilot/gpt-5.2-codex"
    "github-copilot/claude-sonnet-4.5"
    "github-copilot-enterprise/gpt-5.2-codex"
    "github-copilot-enterprise/claude-sonnet-4.5"
    "openai/gpt-5.2-codex"
    "openai/gpt-5.1-codex-max"
    "google/gemini-3-pro-preview"
    "opencode/grok-code"
)

# Model Priority: Plan Phase (Reasoning/Architecture)
# Deep thinking models for mapping and complex task breakdown
PLAN_MODELS_PREF=(
    "github-copilot/claude-opus-4.5"
    "github-copilot-enterprise/claude-opus-4.5"
    "openai/gpt-5.2"
    "google/antigravity-claude-opus-4-5-thinking"
    "google/gemini-3-pro-preview"
    "opencode/glm-4.7-free"
)

# Reviewer Model (Fast Check)
MODEL_REVIEWER="github-copilot/gemini-3-flash-preview"

# --- Setup Directories ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
ENGINE_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
PROJECT_DIR="$(pwd)"
RUNS_DIR="$PROJECT_DIR/.ralph/runs"

mkdir -p "$RUNS_DIR"

# --- Parse Args ---
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --watch) WATCH_MODE="true"; shift ;;
        *) ITERATIONS="$1"; shift ;;
    esac
done

echo "ü§ñ Ralph v3.0 (Split-Brain Architecture)"
echo "   Engine:  $ENGINE_DIR"
echo "   Context: $PROJECT_DIR"

# --- Smart Model Discovery ---
get_available_models() {
    local PREF_MODELS=("$@")
    local AVAILABLE_MODELS=()
    
    echo "üîç Verifying available models..." >&2
    
    # Get list of all available models from opencode
    local ALL_MODELS=$(opencode models --refresh | grep -E "^[a-z0-9-]+\/[a-z0-9.-]+" || true)
    
    for PREF in "${PREF_MODELS[@]}"; do
        if echo "$ALL_MODELS" | grep -q "^$PREF$"; then
            AVAILABLE_MODELS+=("$PREF")
        fi
    done
    
    # If no preferred models found, fallback to generic safe bets
    if [ ${#AVAILABLE_MODELS[@]} -eq 0 ]; then
        echo "‚ö†Ô∏è  No preferred models found. Falling back to generic discovery." >&2
        AVAILABLE_MODELS+=($(echo "$ALL_MODELS" | grep "gpt-4o" | head -n 1))
        AVAILABLE_MODELS+=($(echo "$ALL_MODELS" | grep "claude-sonnet" | head -n 1))
    fi
    
    echo "${AVAILABLE_MODELS[@]}"
}

# Pre-fetch available models for both phases
echo "   Configuring Build Models..."
read -r -a BUILD_MODELS <<< "$(get_available_models "${BUILD_MODELS_PREF[@]}")"
echo "   Build Chain: ${BUILD_MODELS[*]}"

echo "   Configuring Plan Models..."
read -r -a PLAN_MODELS <<< "$(get_available_models "${PLAN_MODELS_PREF[@]}")"
echo "   Plan Chain:  ${PLAN_MODELS[*]}"


# --- Initialization & Migration ---
if [ ! -f "$PROJECT_DIR/prd.md" ]; then
    if [ -f "$PROJECT_DIR/prd.json" ]; then
        echo "üîÑ Migrating legacy prd.json to prd.md..."
        # Simple jq extraction to markdown list
        jq -r '.[] | "- [ ] " + .description' "$PROJECT_DIR/prd.json" > "$PROJECT_DIR/prd.md"
        mv "$PROJECT_DIR/prd.json" "$PROJECT_DIR/prd.json.bak"
    else
        echo "‚ö†Ô∏è  No prd.md found. Initializing..."
        cat > "$PROJECT_DIR/prd.md" <<EOF
# Product Requirements Document (PRD)

- [ ] Initialize repo-map.md with project architecture
- [ ] Setup initial project structure
EOF
    fi
fi

if [ ! -f "$PROJECT_DIR/repo-map.md" ]; then
    touch "$PROJECT_DIR/repo-map.md"
fi

if [ ! -f "$PROJECT_DIR/prd.state.json" ]; then
    echo "{}" > "$PROJECT_DIR/prd.state.json"
fi

touch "$PROJECT_DIR/progress.log"

# --- Helper Functions ---

detect_phase() {
    # If repo-map is empty, we must PLAN first
    if [ ! -s "$PROJECT_DIR/repo-map.md" ]; then
        echo "PLAN"
        return
    fi
    echo "BUILD"
}

get_current_prd_hash() {
    md5sum "$PROJECT_DIR/prd.md" | awk '{print $1}'
}

prepare_iteration_context() {
    local ITER_ID="$1"
    local ITER_DIR="$RUNS_DIR/$ITER_ID"
    mkdir -p "$ITER_DIR"
    
    # Create a tail of the progress log for the agent (Last 200 lines)
    tail -n 200 "$PROJECT_DIR/progress.log" > "$ITER_DIR/progress.tail.log"
    
    # Symlink latest for easy debugging
    rm -f "$RUNS_DIR/latest"
    ln -s "$ITER_DIR" "$RUNS_DIR/latest"
    
    echo "$ITER_DIR"
}

run_agent() {
    local MODEL="$1"
    local PHASE="$2"
    local ITER_DIR="$3"
    
    local SYSTEM_PROMPT="$ENGINE_DIR/prompt.md"
    local PROMPT_SUFFIX=""

    if [ "$PHASE" == "PLAN" ]; then
        PROMPT_SUFFIX="MODE: PLAN. Focus on exploring and mapping. Do NOT write implementation code yet."
    else
        PROMPT_SUFFIX="MODE: BUILD. Focus on completing tasks in prd.md."
    fi

    # Execute Agent
    # We pipe to tee to show output in real-time AND save to file
    echo "   Thinking..."
    opencode run "Proceed with task. $PROMPT_SUFFIX" \
        --file "$SYSTEM_PROMPT" \
        --file "$PROJECT_DIR/prd.md" \
        --file "$PROJECT_DIR/prd.state.json" \
        --file "$PROJECT_DIR/repo-map.md" \
        --file "$ITER_DIR/progress.tail.log" \
        --agent general \
        --model "$MODEL" | tee "$ITER_DIR/agent_response.txt"
}

# --- Main Loop ---
LAST_HASH=$(get_current_prd_hash)
i=1

while true; do
    # Watch Mode Check
    CURRENT_HASH=$(get_current_prd_hash)
    if [[ "$CURRENT_HASH" != "$LAST_HASH" ]]; then
        echo "üëÄ PRD Changed! Restarting loop..."
        echo "--- PRD CHANGED: RESTARTING LOOP ---" >> "$PROJECT_DIR/progress.log"
        LAST_HASH="$CURRENT_HASH"
        i=1
    fi

    if [[ "$WATCH_MODE" != "true" ]] && ((i > ITERATIONS)); then
        echo "‚è∏Ô∏è  Max iterations reached."
        break
    fi

    PHASE=$(detect_phase)
    ITER_ID=$(printf "iter-%04d" $i)
    ITER_DIR=$(prepare_iteration_context "$ITER_ID")
    
    echo ""
    echo "üîÅ Loop $i ($PHASE Phase)"
    echo "   Logs: $ITER_DIR"

    # Select Models based on Phase
    if [ "$PHASE" == "PLAN" ]; then
        MODELS=("${PLAN_MODELS[@]}")
    else
        MODELS=("${BUILD_MODELS[@]}")
    fi

    # Try models in priority order
    SUCCESS=false
    for MODEL in "${MODELS[@]}"; do
        echo "   Using: $MODEL"
        set +e
        run_agent "$MODEL" "$PHASE" "$ITER_DIR"
        EXIT_CODE=$?
        set -e
        
        RESPONSE=$(cat "$ITER_DIR/agent_response.txt")
        
        if [ $EXIT_CODE -eq 0 ] && [ -n "$RESPONSE" ]; then
            SUCCESS=true
            echo "$RESPONSE"
            
            # Check for completion
            if echo "$RESPONSE" | grep -q "<promise>COMPLETE</promise>"; then
                echo "‚úÖ Agent signaled completion."
                if [[ "$WATCH_MODE" != "true" ]]; then exit 0; fi
            fi
            break
        else
            echo "   ‚ö†Ô∏è  Model $MODEL failed. Falling back..."
        fi
    done

    if [ "$SUCCESS" = false ]; then
        echo "‚ùå All models failed this iteration."
        sleep 2
    fi

    ((i++))
    sleep 1
done
